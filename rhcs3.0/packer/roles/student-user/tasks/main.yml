---

- fail:
    msg: "variable instructor_pub_key_file not defined"
  when: instructor_pub_key_file is not defined

- stat: path={{ instructor_pub_key_file }}
  register: pub_key_file
  delegate_to: localhost
  become: false

- fail:
    msg: "{{ instructor_pub_key_file }} is not a valid file"
  when: not pub_key_file.stat.exists

- name: create student account
  user:
    name: student 
    password: '$6$0QTKiAxX5.ONsPxA$keFvFhrX6cRqYiN4OLSezEopULJFO4da7K7hl2sromKY69CvumfAgotEB9K1gmcjakjrdEkbA2Ku6m2Rsry9D0'
    groups: wheel
    append: yes
    generate_ssh_key: true

- name: set password-less sudo for student user
  lineinfile:
    line: "student           ALL=(ALL) NOPASSWD: ALL"
    path: /etc/sudoers
    state: present

- name: add supplied pub key to student's authorized keys
  authorized_key:
    user: student 
    state: present
    key: "{{ lookup('file', instructor_pub_key_file) }}"

- name: fetch student's own pub key
  fetch:
    src: /home/student/.ssh/id_rsa.pub
    dest: fetch/student_key.pub
    flat: yes

- name: add student's own key to authorized keys for effortless cross system login
  authorized_key:
    user: student 
    state: present
    key: "{{ lookup('file', 'fetch/student_key.pub') }}"

...
