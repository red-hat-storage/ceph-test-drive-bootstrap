<!DOCTYPE html>
<!--[if lt IE 7 ]><html class="no-js ie6"><![endif]-->
<!--[if IE 7 ]><html class="no-js ie7"><![endif]-->
<!--[if IE 8 ]><html class="no-js ie8"><![endif]-->
<!--[if IE 9 ]><html class="no-js ie9"><![endif]-->
<!--[if (gt IE 9)|!(IE)]><!--> <html class="no-js"> <!--<![endif]-->
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1,maximum-scale=1">
    
      
        <title>Module-3 Ceph Object Storage - Red Hat Ceph Storage Test Drive</title>
      
      
      
      
    
    <meta property="og:url" content="None">
    <meta property="og:title" content="Red Hat Ceph Storage Test Drive">
    <meta property="og:image" content="None/../">
    <meta name="apple-mobile-web-app-title" content="Red Hat Ceph Storage Test Drive">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    
    
    <link rel="shortcut icon" type="image/x-icon" href="../../images/favicon.ico">
    <link rel="icon" type="image/x-icon" href="../../images/favicon.ico">
    <style>
      @font-face {
      	font-family: 'Icon';
      	src: url('../assets/fonts/icon.eot?52m981');
      	src: url('../assets/fonts/icon.eot?#iefix52m981')
               format('embedded-opentype'),
      		   url('../assets/fonts/icon.woff?52m981')
               format('woff'),
      		   url('../assets/fonts/icon.ttf?52m981')
               format('truetype'),
      		   url('../assets/fonts/icon.svg?52m981#icon')
               format('svg');
      	font-weight: normal;
      	font-style: normal;
      }
    </style>
    <link rel="stylesheet" href="../assets/stylesheets/application-a422ff04cc.css">
    
    
      
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,700|Ubuntu+Mono">
      <style>
        body, input {
          font-family: 'Ubuntu', Helvetica, Arial, sans-serif;
        }
        pre, code {
          font-family: 'Ubuntu Mono', 'Courier New', 'Courier', monospace;
        }
      </style>
    
    
    <script src="../assets/javascripts/modernizr-4ab42b99fd.js"></script>
    
  </head>
  
  
  
  <body class=" ">
    
    <div class="backdrop">
      <div class="backdrop-paper"></div>
    </div>
    <input class="toggle" type="checkbox" id="toggle-drawer">
    <input class="toggle" type="checkbox" id="toggle-search">
    <label class="toggle-button overlay" for="toggle-drawer"></label>
    <header class="header">
      <nav aria-label="Header">
  <div class="bar default">
    <div class="button button-menu" role="button" aria-label="Menu">
      <label class="toggle-button icon icon-menu" for="toggle-drawer">
        <span></span>
      </label>
    </div>
    <div class="stretch">
      <div class="title">
        
          <span class="path">
            
              
                Modules <i class="icon icon-link"></i>
              
            
          </span>
        
        Module-3 Ceph Object Storage
      </div>
    </div>
    
    
    <div class="button button-search" role="button" aria-label="Search">
      <label class="toggle-button icon icon-search" title="Search" for="toggle-search"></label>
    </div>
  </div>
  <div class="bar search">
    <div class="button button-close" role="button" aria-label="Close">
      <label class="toggle-button icon icon-back" for="toggle-search"></label>
    </div>
    <div class="stretch">
      <div class="field">
        <input class="query" type="text" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck>
      </div>
    </div>
    <div class="button button-reset" role="button" aria-label="Search">
      <button class="toggle-button icon icon-close" id="reset-search"></button>
    </div>
  </div>
</nav>
    </header>
    <main class="main">
      
      <div class="drawer">
        <nav aria-label="Navigation">
  
  <a href="/" class="project">
    <div class="banner">
      
      <div class="name">
        <strong>
          Red Hat Ceph Storage Test Drive
          <span class="version">
            
          </span>
        </strong>
        
      </div>
    </div>
  </a>
  <div class="scrollable">
    <div class="wrapper">
      
      <div class="toc">
        <ul>
          
            
  <li>
    <a class="" title="Home" href="..">
      Home
    </a>
    
  </li>

          
            
  <li>
    <span class="section">Modules</span>
    <ul>
      
        
  <li>
    <a class="" title="Module-1 Cluster Setup" href="../Module-1/">
      Module-1 Cluster Setup
    </a>
    
  </li>

      
        
  <li>
    <a class="" title="Module-2 Ceph Block Storage" href="../Module-2/">
      Module-2 Ceph Block Storage
    </a>
    
  </li>

      
        
  <li>
    <a class="current" title="Module-3 Ceph Object Storage" href="./">
      Module-3 Ceph Object Storage
    </a>
    
      
        
      
      
        <ul>
          
            <li class="anchor">
              <a title="Installing and configuring Ceph RGW" href="#installing-and-configuring-ceph-rgw">
                Installing and configuring Ceph RGW
              </a>
            </li>
          
            <li class="anchor">
              <a title="Access Ceph object storage using swift API" href="#access-ceph-object-storage-using-swift-api">
                Access Ceph object storage using swift API
              </a>
            </li>
          
            <li class="anchor">
              <a title="Access Ceph object storage using S3 API" href="#access-ceph-object-storage-using-s3-api">
                Access Ceph object storage using S3 API
              </a>
            </li>
          
        </ul>
      
    
  </li>

      
    </ul>
  </li>

          
        </ul>
        
      </div>
    </div>
  </div>
</nav>
      </div>
      <article class="article">
        <div class="wrapper">
          
          <h1 id="module-3-ceph-object-storage-interface">Module 3 - Ceph Object Storage interface<a class="headerlink" href="#module-3-ceph-object-storage-interface" title="Permanent link">#</a></h1>
<p>The Ceph object gateway, also know as the RADOS gateway, is an object storage interface built on top of the librados API to provide applications with a RESTful gateway to Ceph storage clusters. </p>
<p>To access Ceph over object storage interfaces i.e. via <code>swift</code> or <code>s3</code> we need to configure Ceph Rados Gateway component. In this module we will configure <code>rgw-node1</code>  as Ceph Rados Gateway and then test <code>s3</code> and <code>swift</code> from <code>client-node1</code> </p>
<pre class="code"><code>## Note: ##

Before proceeding with this module make sure you have completed Module-1 and have a running Ceph cluster.</code></pre>


<h2 id="installing-and-configuring-ceph-rgw">Installing and configuring Ceph RGW<a class="headerlink" href="#installing-and-configuring-ceph-rgw" title="Permanent link">#</a></h2>
<ul>
<li>On <code>mgmt</code> node as <code>ceph</code> navigate to <code>/usr/share/ceph-ansible/group_vars</code> directory</li>
</ul>
<pre class="code"><code>$ cd /usr/share/ceph-ansible/group_vars</code></pre>


<ul>
<li>Edit  <code>all</code> file </li>
</ul>
<pre class="code"><code>$ sudo vi all</code></pre>


<ul>
<li>Uncomment <code>radosgw_dns_name</code> and set it to <code>rgw-node1</code> </li>
</ul>
<pre class="code"><code>radosgw_dns_name: rgw-node1</code></pre>


<ul>
<li>Uncomment <code>radosgw_frontend</code> setting, save and exit file editor</li>
</ul>
<pre class="code"><code>radosgw_frontend: civetweb</code></pre>


<ul>
<li>Create an <code>rgws</code> file from <code>rgws.sample</code> file and open it for editing</li>
</ul>
<pre class="code"><code>$ sudo cp rgws.sample rgws
$ sudo vi rgws</code></pre>


<ul>
<li>Uncomment the <code>copy_admin_key</code> setting and set it to <code>true</code> </li>
</ul>
<pre class="code"><code>copy_admin_key: true</code></pre>


<ul>
<li>Add Ceph RGW host to Ansible inventory file. Edit <code>/etc/ansible/hosts</code>  file</li>
</ul>
<pre class="code"><code>$ sudo vi /etc/ansible/hosts</code></pre>


<ul>
<li>Add the following section to <code>/etc/ansible/hosts</code>  file, save and exit file editor</li>
</ul>
<pre class="code"><code>[rgws]
rgw-node1</code></pre>


<ul>
<li>Your Ansible inventory file should look like this</li>
</ul>
<pre class="code"><code>[mons]
mon-node1
mon-node2
mon-node3
[osds]
osd-node1
osd-node2
osd-node3
[rgws]
rgw-node1</code></pre>


<ul>
<li>Navigate to the Ansible configuration directory <code>/usr/share/ceph-ansible/</code></li>
</ul>
<pre class="code"><code>$ cd /usr/share/ceph-ansible/</code></pre>


<ul>
<li>Run the Ansible playbook</li>
</ul>
<pre class="code"><code>$ ansible-playbook site.yml -u ceph</code></pre>


<pre class="code"><code>## Note: ##

Ansible is idempotent in nature , so there is no harm in running it again. Configuration change will not take place after its initial application.</code></pre>


<ul>
<li>Once Ansible run is completed, make sure there is no failed item under <code>PLAY RECAP</code> </li>
<li>Verify <code>ceph-radosgw</code> service is running on <code>rgw-node1</code> , also make a note of port number its running on. It must be 8080</li>
</ul>
<pre class="code"><code>$ ssh rgw-node1 systemctl status ceph-radosgw@rgw.rgw-node1.service
$ ssh rgw-node1 -t sudo netstat -plunt | grep -i rados</code></pre>


<ul>
<li>Login to <code>rgw-node</code> to create Radow Gateway user account which will be used by <code>S3</code> and <code>swift</code> API's to access Ceph storage via object storage interface</li>
</ul>
<pre class="code"><code>$ ssh rgw-node1</code></pre>


<ul>
<li>Create RGW user for <code>S3</code> access </li>
</ul>
<pre class="code"><code>$ radosgw-admin user create --uid='user1' --display-name='First User' --access-key='S3user1' --secret-key='S3user1key'</code></pre>


<ul>
<li>Create RGW subuser for <code>swift</code> access</li>
</ul>
<pre class="code"><code>$ radosgw-admin subuser create --uid='user1' --subuser='user1:swift' --secret-key='Swiftuser1key' --access=full</code></pre>


<p>At this point you have a running and configured Ceph RGW instance. In the next section we will learn about accessing Ceph via object storage interfaces.</p>
<h2 id="access-ceph-object-storage-using-swift-api">Access Ceph object storage using swift API<a class="headerlink" href="#access-ceph-object-storage-using-swift-api" title="Permanent link">#</a></h2>
<ul>
<li>Login to <code>client-node</code></li>
</ul>
<pre class="code"><code>$ ssh client-node1</code></pre>


<ul>
<li>Install <code>python-swiftclient</code> </li>
</ul>
<pre class="code"><code>$ sudo pip install python-swiftclient</code></pre>


<ul>
<li>Using swift cli , lets try to list swift containers. Although it will not list anything as there are no containers.</li>
</ul>
<pre class="code"><code>$ swift -A http://rgw-node1:8080/auth/1.0  -U user1:swift -K 'Swiftuser1key' list</code></pre>


<ul>
<li>Create a swift container named <code>container-1</code> and then list it</li>
</ul>
<pre class="code"><code>$ swift -A http://rgw-node1:8080/auth/1.0  -U user1:swift -K 'Swiftuser1key' post container-1
$ swift -A http://rgw-node1:8080/auth/1.0  -U user1:swift -K 'Swiftuser1key' list</code></pre>


<ul>
<li>Create a dummy file and then upload this file to <code>container-1</code> using swift</li>
</ul>
<pre class="code"><code>$ base64 /dev/urandom | head -c 10000000 &gt; dummy_file1.txt
$ swift -A http://rgw-node1:8080/auth/1.0  -U user1:swift -K 'Swiftuser1key' upload container-1 dummy_file1.txt</code></pre>


<ul>
<li>List <code>container-1</code> to verify files are getting stored</li>
</ul>
<pre class="code"><code>$ swift -A http://rgw-node1:8080/auth/1.0  -U user1:swift -K 'Swiftuser1key' list container-1</code></pre>


<p>Easy right !! So you have just learned how to use Ceph as Object Storage System using swift APIs. Follow the next section to know how S3 can be used with Ceph.</p>
<h2 id="access-ceph-object-storage-using-s3-api">Access Ceph object storage using S3 API<a class="headerlink" href="#access-ceph-object-storage-using-s3-api" title="Permanent link">#</a></h2>
<p>Ceph object storage cluster can be accessed by any client which talks <code>S3</code> API.  In this section we will use <code>s3cmd</code> which has already been installed on <code>client-node1</code> machine.</p>
<ul>
<li>Login to <code>client-node1</code></li>
</ul>
<pre class="code"><code>$ ssh client-node1</code></pre>


<ul>
<li>To use Ceph with S3-style subdomains (e.g., bucket-name.domain-name.com), you need to add a wildcard to the DNS record of the DNS server you use with the ceph-radosgw daemon. We will install <code>dnsmasq</code> which is a lightweight DNS server.</li>
</ul>
<pre class="code"><code>$ sudo yum install -y dnsmasq</code></pre>


<ul>
<li>Configure dnsmasq to resolve subdomains to Ceph RGW address and start dnsmasq service</li>
</ul>
<pre class="code"><code>$ echo &quot;address=/.rgw-node1/10.100.2.15&quot; | sudo tee -a /etc/dnsmasq.conf
$ sudo systemctl start dnsmasq
$ sudo systemctl enable dnsmasq</code></pre>


<ul>
<li>Edit <code>/etc/resolv.conf</code>  and add <code>nameserver 127.0.0.1</code> <strong>just after</strong> <code>search ec2.internal</code> line</li>
</ul>
<pre class="code"><code># Generated by NetworkManager
search ec2.internal
nameserver 127.0.0.1
nameserver 10.100.0.2</code></pre>


<ul>
<li>Make sure for any RGW subdomain <code>client-node1</code> is resolving <code>rgw-node1</code> address</li>
</ul>
<pre class="code"><code>$ ping -c 1 anything.rgw-node1
$ ping -c 1 mybucket.rgw-node1
$ ping -c 1 mars.rgw-node1</code></pre>


<ul>
<li>Next we will configure <code>s3cmd</code> </li>
</ul>
<pre class="code"><code>$ s3cmd --configure</code></pre>


<ul>
<li><code>s3cmd</code> configuration will prompt to enter details, use the following  values for configuration.  Enter default values for most of the prompts , however we <strong>do not want</strong> to use <strong>HTTPS</strong> and <strong>test configuration</strong> right away and <strong>we do want</strong> to save settings.</li>
</ul>
<pre class="code"><code>Access Key: S3user1
Secret Key: S3user1key

Default Region [US]: &lt; Just hit Enter &gt;
Encryption password: &lt; Just hit Enter &gt;
Path to GPG program [/usr/bin/gpg]: &lt; Just hit Enter &gt;

Use HTTPS protocol [Yes]: No
HTTP Proxy server name: &lt; Just hit Enter &gt;

Test access with supplied credentials? [Y/n] n
Save settings? [y/N] y</code></pre>


<ul>
<li>Sample <code>s3cmd --configuration</code> wizard </li>
</ul>
<pre class="code"><code>[ceph@client-node1 ~]$ s3cmd --configure

Enter new values or accept defaults in brackets with Enter.
Refer to user manual for detailed description of all options.

Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.
Access Key: S3user1
Secret Key: S3user1key
Default Region [US]:

Encryption password is used to protect your files from reading
by unauthorized persons while in transfer to S3
Encryption password:
Path to GPG program [/usr/bin/gpg]:

When using secure HTTPS protocol all communication with Amazon S3
servers is protected from 3rd party eavesdropping. This method is
slower than plain HTTP, and can only be proxied with Python 2.7 or newer
Use HTTPS protocol [Yes]: No

On some networks all internet access must go through a HTTP proxy.
Try setting it here if you can't connect to S3 directly
HTTP Proxy server name:

New settings:
  Access Key: S3user1
  Secret Key: S3user1key
  Default Region: US
  Encryption password:
  Path to GPG program: /usr/bin/gpg
  Use HTTPS protocol: No
  HTTP Proxy server name:
  HTTP Proxy server port: 0

Test access with supplied credentials? [Y/n] n

Save settings? [y/N] y
Configuration saved to '/home/ceph/.s3cfg'
[ceph@client-node1 ~]$</code></pre>


<ul>
<li>Next edit <code>/home/ceph/.s3cfg</code> file, update <code>host_base</code> and <code>host_bucket</code> as shown below. Save and exit editor</li>
</ul>
<pre class="code"><code>host_base = rgw-node1:8080
host_bucket = %(bucket)s.rgw-node1:8080</code></pre>


<ul>
<li>Test Ceph object storage via S3 protocol by listing buckets using <code>s3cmd</code>. It should list buckets that you have created using <code>swift</code> in the last section </li>
</ul>
<pre class="code"><code>$ s3cmd ls</code></pre>


<ul>
<li>Create a new bucket</li>
</ul>
<pre class="code"><code>$ s3cmd mb s3://s3-bucket
$ s3cmd ls</code></pre>


<ul>
<li>Create a dummy file and then upload this file to <code>s3-bucket</code> via S3 API</li>
</ul>
<pre class="code"><code>$ base64 /dev/urandom | head -c 10000000 &gt; dummy_file2.txt
$ s3cmd put dummy_file2.txt s3://s3-bucket
$ s3cmd ls s3://s3-bucket</code></pre>


<blockquote>
<p>All done !! Great !!  In this module you have learned to use Ceph cluster as object storage using S3 and Swift APIs. You application will use the same procedure to storage objects to Ceph cluster.</p>
</blockquote>
          <aside class="copyright" role="note">
            
              Copyright ©2016 Red Hat, Inc. &ndash;
            
            Documentation built with
            <a href="http://www.mkdocs.org" target="_blank">MkDocs</a>
            using the
            <a href="http://squidfunk.github.io/mkdocs-material/" target="_blank">
              Material
            </a>
            theme.
          </aside>
          
            <footer class="footer">
              
  <nav class="pagination" aria-label="Footer">
    <div class="previous">
      
        <a href="../Module-2/" title="Module-2 Ceph Block Storage">
          <span class="direction">
            Previous
          </span>
          <div class="page">
            <div class="button button-previous" role="button" aria-label="Previous">
              <i class="icon icon-back"></i>
            </div>
            <div class="stretch">
              <div class="title">
                Module-2 Ceph Block Storage
              </div>
            </div>
          </div>
        </a>
      
    </div>
    <div class="next">
      
    </div>
  </nav>

            </footer>
          
        </div>
      </article>
      <div class="results" role="status" aria-live="polite">
        <div class="scrollable">
          <div class="wrapper">
            <div class="meta"></div>
            <div class="list"></div>
          </div>
        </div>
      </div>
    </main>
    <script>
      var base_url = '..';
      var repo_id  = '';
    </script>
    <script src="../assets/javascripts/application-997097ee0c.js"></script>
    
    
  </body>
</html>