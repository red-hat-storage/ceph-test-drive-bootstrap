{
  "AWSTemplateFormatVersion" : "2010-09-09",

  "Description" : "Red Hat Ceph Storage 2.0 Test Drive",

  "Parameters" : {

    "EnabledAZs" : {
      "Description" : "List of AZs enabled for this account and region",
      "Type" : "CommaDelimitedList"
    },

    "KeyName" : {
      "Description" : "Name of an EC2 KeyPair to SSH into instances",
      "Type" : "String",
      "MinLength": "1",
      "MaxLength": "64",
      "Default" : "RHSSHKey",
      "NoEcho": "true",
      "AllowedPattern" : "[-_ a-zA-Z0-9]*",
      "ConstraintDescription" : "can contain only alphanumeric characters, spaces, dashes and underscores."
    },


    "CustomerRef" : {
      "Description" : "Red Hat Storage Customer Reference for Tagging Resources",
      "Type" : "String",
      "Default" : "DefaultRef"
    },


    "CustomerEmailRef" : {
      "Description" : "Red Hat Storage Customer Email Reference for Tagging Resources",
      "Type" : "String",
      "Default" : "DefaultEmailRef"
    },


    "NATInstanceType" : {
      "Description" : "NAT Device EC2 instance type",
      "Type" : "String",
      "Default" : "m3.xlarge",
      "NoEcho": "true",
      "AllowedValues" : [ "t1.micro","m1.small","m1.medium","m1.large","m1.xlarge","m2.xlarge","m2.2xlarge","m3.xlarge","m2.4xlarge","c1.medium","c1.xlarge","cc1.4xlarge","cc2.8xlarge","cg1.4xlarge"],
      "ConstraintDescription" : "must be a valid EC2 instance type."
    },

    "RedHatStorageServerInstanceType" : {
      "Description" : "Red Hat Storage Server EC2 instance type",
      "Type" : "String",
      "Default" : "m4.xlarge",
      "NoEcho": "true"
    },

    "RedHatStorageClientInstanceType" : {
      "Description" : "Red Hat Storage Clients EC2 instance type",
      "Type" : "String",
      "Default" : "m4.large",
      "NoEcho": "true"
    }
},

  "Mappings" : {
    
    "AWSNATAMI" : {
      "us-east-1"      : { "AMI" : "ami-dd3dd7cb" },
      "us-west-1"      : { "AMI" : "ami-7d54061d" },
      "us-west-2"      : { "AMI" : "ami-3b6fd05b" },
      "eu-west-1"      : { "AMI" : "ami-47ecb121" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },


    "RHSSERVERAMI" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

    "RHSSERVERAMI1" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

    "RHSSERVERAMI2" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

    "RHSSERVERAMI3" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

    "RHSSERVERAMI4" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

    "RHSCLIENTAMI1" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

   "RHSCLIENTAMI2" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

   "RHSCLIENTAMI3" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

   "MON1AMI" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

   "MON2AMI" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

   "MON3AMI" : {
      "us-east-1"      : { "AMI" : "ami-2051294a" },
      "us-west-2"      : { "AMI" : "ami-775e4f16" },
      "us-west-1"      : { "AMI" : "ami-d1315fb1" },
      "eu-west-1"      : { "AMI" : "ami-8b8c57f8" },
      "ap-southeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "ap-northeast-1" : { "AMI" : "ami-xxxxxxxx" },
      "sa-east-1"      : { "AMI" : "ami-xxxxxxxx" }
    },

    "AWSInstanceType2Arch" : {
      "t1.micro"    : { "Arch" : "64" },
      "m1.small"    : { "Arch" : "64" },
      "m1.medium"   : { "Arch" : "64" },
      "m1.large"    : { "Arch" : "64" },
      "m1.xlarge"   : { "Arch" : "64" },
      "m2.xlarge"   : { "Arch" : "64" },
      "m2.2xlarge"  : { "Arch" : "64" },
      "m2.4xlarge"  : { "Arch" : "64" },
      "c1.medium"   : { "Arch" : "64" },
      "c1.xlarge"   : { "Arch" : "64" },
      "cc1.4xlarge" : { "Arch" : "64Cluster" },
      "cc2.8xlarge" : { "Arch" : "64Cluster" },
      "cg1.4xlarge" : { "Arch" : "64GPU" }
    },

    "SubnetConfig" : {
      "VPC"     : { "CIDR" : "10.100.0.0/16" },
      "Public"  : { "CIDR" : "10.100.0.0/24" },
      "Private1" : { "CIDR" : "10.100.1.0/24" },
      "Private2" : { "CIDR" : "10.100.2.0/24" }
    }
},

  "Resources" : {

    "VPC" : {
      "Type" : "AWS::EC2::VPC",
      "Properties" : {
        "CidrBlock" : { "Fn::FindInMap" : [ "SubnetConfig", "VPC", "CIDR" ]},
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Public" }
        ]
      }
    },


    "PublicSubnet" : {
      "Type" : "AWS::EC2::Subnet",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::FindInMap" : [ "SubnetConfig", "Public", "CIDR" ]},
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Public" }
        ]
      }
    },

    "InternetGateway" : {
      "Type" : "AWS::EC2::InternetGateway",
      "Properties" : {
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Public" }
        ]
      }
    },

    "GatewayToInternet" : {
       "Type" : "AWS::EC2::VPCGatewayAttachment",
       "DependsOn" : ["VPC", "InternetGateway"],
       "Properties" : {
         "VpcId" : { "Ref" : "VPC" },
         "InternetGatewayId" : { "Ref" : "InternetGateway" }
       }
    },

    "PublicRouteTable" : {
      "Type" : "AWS::EC2::RouteTable",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Public" }
        ]
      }
    },

    "PublicRoute" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : ["PublicRouteTable", "InternetGateway"],
      "Properties" : {
        "RouteTableId" : { "Ref" : "PublicRouteTable" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "GatewayId" : { "Ref" : "InternetGateway" }
      }
    },

    "PublicSubnetRouteTableAssociation" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "DependsOn" : [ "PublicRouteTable",  "PublicSubnet"],
      "Properties" : {
        "SubnetId" : { "Ref" : "PublicSubnet" },
        "RouteTableId" : { "Ref" : "PublicRouteTable" }
      }
    },

    "PublicNetworkAcl" : {
      "Type" : "AWS::EC2::NetworkAcl",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Public" }
        ]
      }
    },

    "InboundHTTPPublicNetworkAclEntry" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PublicNetworkAcl",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PublicNetworkAcl" },
        "RuleNumber" : "100",
        "Protocol" : "-1",
        "RuleAction" : "allow",
        "Egress" : "false",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "0", "To" : "65535" }
      }
    },

    "OutboundPublicNetworkAclEntry" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PublicNetworkAcl",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PublicNetworkAcl" },
        "RuleNumber" : "100",
        "Protocol" : "-1",
        "RuleAction" : "allow",
        "Egress" : "true",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "0", "To" : "65535" }
      }
    },

    "PublicSubnetNetworkAclAssociation" : {
      "Type" : "AWS::EC2::SubnetNetworkAclAssociation",
      "DependsOn": [ "PublicSubnet", "PublicNetworkAcl"],
      "Properties" : {
        "SubnetId" : { "Ref" : "PublicSubnet" },
        "NetworkAclId" : { "Ref" : "PublicNetworkAcl" }
      }
    },

    "PrivateSubnet1" : {
      "Type" : "AWS::EC2::Subnet",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::FindInMap" : [ "SubnetConfig", "Private1", "CIDR" ]},
        "AvailabilityZone": { "Fn::Select" : [ "0", { "Ref" : "EnabledAZs" } ] },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Private1" }
        ]
      }
    },

    "PrivateRouteTable1" : {
      "Type" : "AWS::EC2::RouteTable",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Private1" }
        ]
      }
    },

    "PrivateSubnetRouteTableAssociation1" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "DependsOn" : [ "PrivateSubnet1", "PrivateRouteTable1" ],
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnet1" },
        "RouteTableId" : { "Ref" : "PrivateRouteTable1" }
      }
    },

    "PrivateRoute1" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : ["PrivateRouteTable1", "NATDevice" ],
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTable1" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "InstanceId" : { "Ref" : "NATDevice" }
      }
    },

    "PrivateNetworkAcl1" : {
      "Type" : "AWS::EC2::NetworkAcl",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Private1" }
        ]
      }
    },

    "InboundPrivateNetworkAclEntry1" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PrivateNetworkAcl1",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl1" },
        "RuleNumber" : "100",
        "Protocol" : "-1",
        "RuleAction" : "allow",
        "Egress" : "false",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "0", "To" : "65535" }
      }
    },

    "OutBoundPrivateNetworkAclEntry1" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PrivateNetworkAcl1",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl1" },
        "RuleNumber" : "100",
        "Protocol" : "-1",
        "RuleAction" : "allow",
        "Egress" : "true",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "0", "To" : "65535" }
      }
    },

    "PrivateSubnetNetworkAclAssociation1" : {
      "Type" : "AWS::EC2::SubnetNetworkAclAssociation",
      "DependsOn" : ["PrivateSubnet1", "PrivateNetworkAcl1"],
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnet1" },
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl1" }
      }
    },


    "PrivateSubnet2" : {
      "Type" : "AWS::EC2::Subnet",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "CidrBlock" : { "Fn::FindInMap" : [ "SubnetConfig", "Private2", "CIDR" ]},
        "AvailabilityZone": { "Fn::Select" : [ "0", { "Ref" : "EnabledAZs" } ] },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Private2" }
        ]
      }
    },

    "PrivateRouteTable2" : {
      "Type" : "AWS::EC2::RouteTable",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Private2" }
        ]
      }
    },

    "PrivateSubnetRouteTableAssociation2" : {
      "Type" : "AWS::EC2::SubnetRouteTableAssociation",
      "DependsOn" : [ "PrivateSubnet2", "PrivateNetworkAcl2" ],
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnet2" },
        "RouteTableId" : { "Ref" : "PrivateRouteTable2" }
      }
    },

    "PrivateRoute2" : {
      "Type" : "AWS::EC2::Route",
      "DependsOn" : [ "PrivateRouteTable2", "NATDevice" ],
      "Properties" : {
        "RouteTableId" : { "Ref" : "PrivateRouteTable2" },
        "DestinationCidrBlock" : "0.0.0.0/0",
        "InstanceId" : { "Ref" : "NATDevice" }
      }
    },

    "PrivateNetworkAcl2" : {
      "Type" : "AWS::EC2::NetworkAcl",
      "DependsOn" : "VPC",
      "Properties" : {
        "VpcId" : { "Ref" : "VPC" },
        "Tags" : [
          { "Key" : "Application", "Value" : { "Ref" : "AWS::StackName" } },
          { "Key" : "Network", "Value" : "Private2" }
        ]
      }
    },

    "InboundPrivateNetworkAclEntry2" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PrivateNetworkAcl2",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl2" },
        "RuleNumber" : "100",
        "Protocol" : "-1",
        "RuleAction" : "allow",
        "Egress" : "false",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "0", "To" : "65535" }
      }
    },
    "InboundSSHPrivateNetworkAclEntry2" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PrivateNetworkAcl2",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl2" },
        "RuleNumber" : "101",
        "Protocol" : "6",
        "RuleAction" : "allow",
        "Egress" : "false",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "22", "To" : "22" }
      }
    },

    "OutBoundPrivateNetworkAclEntry2" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PrivateNetworkAcl2",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl2" },
        "RuleNumber" : "100",
        "Protocol" : "-1",
        "RuleAction" : "allow",
        "Egress" : "true",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "0", "To" : "65535" }
      }
    },

    "OutBoundSSHPrivateNetworkAclEntry2" : {
      "Type" : "AWS::EC2::NetworkAclEntry",
      "DependsOn" : "PrivateNetworkAcl2",
      "Properties" : {
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl2" },
        "RuleNumber" : "101",
        "Protocol" : "6",
        "RuleAction" : "allow",
        "Egress" : "true",
        "CidrBlock" : "0.0.0.0/0",
        "PortRange" : { "From" : "22", "To" : "22" }
      }
    },
    
    "PrivateSubnetNetworkAclAssociation2" : {
      "Type" : "AWS::EC2::SubnetNetworkAclAssociation",
      "DependsOn" : ["PrivateSubnet2", "PrivateNetworkAcl2"],
      "Properties" : {
        "SubnetId" : { "Ref" : "PrivateSubnet2" },
        "NetworkAclId" : { "Ref" : "PrivateNetworkAcl2" }
      }
    },

    "NATDevice" : {
      "Type" : "AWS::EC2::Instance",
      "DependsOn" : "PublicSubnet",
      "Properties" : {
        "InstanceType" : { "Ref" : "NATInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "PublicSubnet" },
        "SourceDestCheck" : "false",
        "ImageId" : { "Fn::FindInMap" : [ "AWSNATAMI", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [{ "Key": "Name", "Value" : "RHS-NAT"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
        "SecurityGroupIds" : [{ "Ref" : "NATSG" }]
      }
    },

    "NATIPAddress" : {
      "Type" : "AWS::EC2::EIP",
      "DependsOn" : "NATDevice",
      "Properties" : {
        "Domain" : "vpc",
        "InstanceId" : { "Ref" : "NATDevice" }
      }
    },

    "PrivateNet1osd1" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"FirstInterface"}],
        "Description": "This is a first private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet1"},
        "PrivateIpAddress": "10.100.1.11"
      }
    },

    "PrivateNet2osd1" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"SecondInterface"}],
        "Description": "This is a second private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet2"},
        "PrivateIpAddress": "10.100.2.16"
      }
    },

    "PrivateNet1osd2" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"FirstInterface"}],
        "Description": "This is a first private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet1"},
        "PrivateIpAddress": "10.100.1.12"
      }
    },

    "PrivateNet2osd2" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"SecondInterface"}],
        "Description": "This is a second private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet2"},
        "PrivateIpAddress": "10.100.2.17"
      }
    },

    "PrivateNet1osd3" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"FirstInterface"}],
        "Description": "This is a first private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet1"},
        "PrivateIpAddress": "10.100.1.13"
      }
    },

    "PrivateNet2osd3" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"SecondInterface"}],
        "Description": "This is a second private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet2"},
        "PrivateIpAddress": "10.100.2.18"
      }
    },

    "PrivateNet1osd4" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"FirstInterface"}],
        "Description": "This is a first private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet1"},
        "PrivateIpAddress": "10.100.1.14"
      }
    },

    "PrivateNet2osd4" : {
     "Type" : "AWS::EC2::NetworkInterface",
     "Properties" : {
        "Tags": [{"Key":"Name","Value":"SecondInterface"}],
        "Description": "This is a second private network interface for osd nodes",
        "SourceDestCheck": "false",
        "GroupSet": [{ "Ref" : "RedHatServerSG" }],
        "SubnetId": {"Ref" : "PrivateSubnet2"},
        "PrivateIpAddress": "10.100.2.19"
      }
    },

    "osdnode1" : {
      "Type" : "AWS::EC2::Instance",
       "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        }, 
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageServerInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "ImageId" : { "Fn::FindInMap" : [ "RHSSERVERAMI1", { "Ref" : "AWS::Region" }, "AMI" ]},
        "NetworkInterfaces" : [ 
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet1osd1"}, "DeviceIndex" : "0" 
          },
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet2osd1"}, "DeviceIndex" : "1" 
          }
        ],
        "Tags" : [{ "Key": "Name", "Value" : "osd-node1"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/sdb",
            "VirtualName" : "ceph-osd1-vol1",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          },{
            "DeviceName" : "/dev/sdc",
            "VirtualName" : "ceph-osd1-vol2",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          },{
            "DeviceName" : "/dev/sdd",
            "VirtualName" : "ceph-osd1-vol3",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          }
        ],
       
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools \n",

              "nmcli dev connect eth1\n",
            
              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl start sshd\n",
              "systemctl enable sshd.service\n",

              "cat << EOF >/etc/hostname\n",
              "osd-node1\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
              
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

            
              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",
                

              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource osdnode1 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },

    "osdnode2" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        }, 
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageServerInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "NetworkInterfaces" : [ 
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet1osd2"}, "DeviceIndex" : "0" 
          },
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet2osd2"}, "DeviceIndex" : "1" 
          }
        ],
        "ImageId" : { "Fn::FindInMap" : [ "RHSSERVERAMI2", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [{ "Key": "Name", "Value" : "osd-node2"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/sdb",
            "VirtualName" : "ceph-osd2-vol1",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          },{
            "DeviceName" : "/dev/sdc",
            "VirtualName" : "ceph-osd2-vol2",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          },{
            "DeviceName" : "/dev/sdd",
            "VirtualName" : "ceph-osd2-vol3",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          }
        ],
       
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
             "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools \n",

              "nmcli dev connect eth1\n",
              
              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",


              "cat << EOF >/etc/hostname\n",
              "osd-node2\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
              

              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "service sshd restart\n",
            
              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",

                
              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource osdnode2 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },


    "osdnode3" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        }, 
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageServerInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "NetworkInterfaces" : [ 
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet1osd3"}, "DeviceIndex" : "0" 
          },
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet2osd3"}, "DeviceIndex" : "1" 
          }
        ],
        "ImageId" : { "Fn::FindInMap" : [ "RHSSERVERAMI3", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [{ "Key": "Name", "Value" : "osd-node3"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/sdb",
            "VirtualName" : "ceph-osd3-vol1",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          },{
            "DeviceName" : "/dev/sdc",
            "VirtualName" : "ceph-osd3-vol2",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          },{
            "DeviceName" : "/dev/sdd",
            "VirtualName" : "ceph-osd3-vol3",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType": "gp2"
            }
          }
        ],
        
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools \n",

              "nmcli dev connect eth1\n",
              
              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

              "cat << EOF >/etc/hostname\n",
              "osd-node3\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
              
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",

              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",

              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",
              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource osdnode3 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },


    "osdnode4" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        }, 
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageServerInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "NetworkInterfaces" : [ 
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet1osd4"}, "DeviceIndex" : "0" 
          },
          {
            "NetworkInterfaceId" : {"Ref" : "PrivateNet2osd4"}, "DeviceIndex" : "1" 
          }
        ],
        "ImageId" : { "Fn::FindInMap" : [ "RHSSERVERAMI4", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [{ "Key": "Name", "Value" : "osd-node4"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
        "BlockDeviceMappings" : [
          {
            "DeviceName" : "/dev/sdb",
            "VirtualName" : "ceph-osd4-vol1",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType":"gp2"
            }
          },{
            "DeviceName" : "/dev/sdc",
            "VirtualName" : "ceph-osd4-vol2",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType":"gp2"
            }
          },{
            "DeviceName" : "/dev/sdd",
            "VirtualName" : "ceph-osd4-vol3",
            "Ebs" : { 
              "VolumeSize" : "100",
              "VolumeType":"gp2"
            }
          }
        ],
        
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools \n",              
              "nmcli dev connect eth1\n",
              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

              "cat << EOF >/etc/hostname\n",
              "osd-node4\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
              

              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",
            
              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",
             

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",


              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",

              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource osdnode4 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },

    "monnode1" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        },
      "DependsOn" : "PrivateSubnet2",
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageClientInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "PrivateSubnet2" },
        "PrivateIpAddress" : "10.100.2.11",
        "ImageId" : { "Fn::FindInMap" : [ "MON1AMI", { "Ref" : "AWS::Region" }, "AMI" ]},
        "SecurityGroupIds" : [{ "Ref" : "RedHatServerSG" }],
        "Tags" : [{ "Key": "Name", "Value" : "mon-node1"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
         
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools \n",

              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

              "cat << EOF >/etc/hostname\n",
              "mon-node1\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",

              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",
            
              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",

              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource monnode1 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },


   "monnode2" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        },
      "DependsOn" : "PrivateSubnet2",
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageClientInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "PrivateSubnet2" },
        "PrivateIpAddress" : "10.100.2.12",
        "ImageId" : { "Fn::FindInMap" : [ "MON3AMI", { "Ref" : "AWS::Region" }, "AMI" ]},
        "SecurityGroupIds" : [{ "Ref" : "RedHatServerSG" }],
        "Tags" : [{ "Key": "Name", "Value" : "mon-node2"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
         
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools\n",

              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

              "cat << EOF >/etc/hostname\n",
              "mon-node2\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
              
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",
            
              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",

              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource monnode2 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },
 
   "monnode3" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        },
      "DependsOn" : "PrivateSubnet2",
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageClientInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "PrivateSubnet2" },
        "PrivateIpAddress" : "10.100.2.13",
        "ImageId" : { "Fn::FindInMap" : [ "MON3AMI", { "Ref" : "AWS::Region" }, "AMI" ]},
        "SecurityGroupIds" : [{ "Ref" : "RedHatServerSG" }],
        "Tags" : [{ "Key": "Name", "Value" : "mon-node3"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
         
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools\n",

              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

              "cat << EOF >/etc/hostname\n",
              "mon-node3\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
              
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",
            
              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",

              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource monnode3 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },

   "clientnode1" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" : []
                }
              }
            }
          }
        }, 
      "DependsOn" : "PrivateSubnet2",
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageClientInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "PrivateSubnet2" },
        "PrivateIpAddress" : "10.100.2.14",
        "ImageId" : { "Fn::FindInMap" : [ "RHSCLIENTAMI2", { "Ref" : "AWS::Region" }, "AMI" ]},
        "SecurityGroupIds" : [{ "Ref" : "RedHatServerSG" }],
        "Tags" : [{ "Key": "Name", "Value" : "client-node1"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],

        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools s3cmd \n",

              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

              "cat << EOF >/etc/hostname\n",
              "client-node1\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
               
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",
          
              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",

            
              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource clientnode1 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },

    "rgwnode1" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd" :[]
                }
              }
            }
          }
        }, 
      "DependsOn" : "PrivateSubnet2",
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageClientInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "PrivateSubnet2" },
        "PrivateIpAddress" : "10.100.2.15",
        "ImageId" : { "Fn::FindInMap" : [ "RHSCLIENTAMI2", { "Ref" : "AWS::Region" }, "AMI" ]},
        "SecurityGroupIds" : [{ "Ref" : "RedHatServerSG" }],
        "Tags" : [{ "Key": "Name", "Value" : "rgw-node1"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y perl wget sshpass python-pip ntp openssh-server python-setuptools vim\n",

              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",

              "cat << EOF >/etc/hostname\n",
              "rgw-node1\n",
              "EOF\n",

              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",
              
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",

              "su --login ceph -c \"mkdir /home/ceph/.ssh\"\n",
              "su --login ceph -c \"touch /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"mkdir /home/admin/.ssh\"\n",
              "su --login admin -c \"touch /home/admin/.ssh/authorized_keys\"\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",
              
              "cat << EOF >/etc/yum.repos.d/RHCS2.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=http://mgmt:8123/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=http://mgmt:8123/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",

              "yum clean all\n", 

              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mgmt\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mgmt\"\n",
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource rgwnode1 ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "yum -y remove epel-release\n"
            ]]
          }
        }
      }
    },

    "mgmt" : {
      "Type" : "AWS::EC2::Instance",
      "Metadata": {
          "AWS::CloudFormation::Init": {
            "config": {
              "packages": {
                "yum": {
                  "ntp" : [],
                  "sshd": [],
                  "httpd" : []
                }
              }
            }
          }
        },
      "DependsOn" : "PublicSubnet",
      "Properties" : {
        "InstanceType" : { "Ref" : "RedHatStorageServerInstanceType" },
        "KeyName"  : { "Ref" : "KeyName" },
        "SubnetId" : { "Ref" : "PublicSubnet" },
        "PrivateIpAddress" : "10.100.0.72",
        "ImageId" : { "Fn::FindInMap" : [ "RHSCLIENTAMI1", { "Ref" : "AWS::Region" }, "AMI" ]},
        "Tags" : [{ "Key": "Name", "Value" : "mgmt"},{ "Key": "CustRef", "Value" : { "Ref" : "CustomerRef" }},{ "Key": "CustEmailRef", "Value" : { "Ref" : "CustomerEmailRef" }}],
        "SecurityGroupIds" : [{ "Ref" : "RedHatClientSG" }], 
        "UserData": {
          "Fn::Base64": {
            "Fn::Join": ["", [
              "#!/bin/bash -v\n",
              "chmod +x /home/*\n",
              "rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm", "\n",
              "yum install -y httpd perl wget sshpass python-pip ntp openssh-server python-setuptools vim\n",

              "systemctl enable ntpd.service\n",
              "systemctl start ntpd\n",
              "ntpq -p\n",
              "systemctl restart sshd\n",
              "systemctl enable sshd\n",
               
              "cat << EOF >/etc/hostname\n",
              "mgmt\n",
              "EOF\n",
              
              "cat << EOF >/etc/hosts\n",
              "127.0.0.1 localhost localhost.localdomain localhost4 localhost4.localdomain4\n",
              "::1       localhost localhost.localdomain localhost6 localhost6.localdomain6\n",
              "#\n",
              "10.100.0.72 mgmt.ec2.internal mgmt ip-10-100-0-72.ec2.internal\n",
              "#\n",
              "10.100.1.11 osd-node1.ec2.internal osd-node1 ip-10.100.1.11.ec2.internal\n",
              "10.100.1.12 osd-node2.ec2.internal osd-node2 ip-10.100.1.12.ec2.internal\n",
              "10.100.1.13 osd-node3.ec2.internal osd-node3 ip-10.100.1.13.ec2.internal\n",
              "10.100.1.14 osd-node4.ec2.internal osd-node4 ip-10.100.1.14.ec2.internal\n",
              "#\n",
              "10.100.2.11 mon-node1.ec2.internal mon-node1 ip-10.100.2.11.ec2.internal\n",
              "10.100.2.12 mon-node2.ec2.internal mon-node2 ip-10.100.2.12.ec2.internal\n",
              "10.100.2.13 mon-node3.ec2.internal mon-node3 ip-10.100.2.13.ec2.internal\n",
              "#\n",
              "10.100.2.14 client-node1.ec2.internal client-node1 ip-10.100.2.14.ec2.internal\n",
              "#\n",
              "10.100.2.15 rgw-node1.ec2.internal rgw-node1 ip-10.100.2.15.ec2.internal\n",
              "EOF\n",

              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root ceph\n",
              "useradd -m -p $(perl -e'print crypt(\"Redhat16\", \"aa\")') -g root admin\n",
              
              "chmod +x /home/ceph/*\n",
              "chmod +x /home/admin/*\n",

              "echo 'ceph ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",
              "echo 'admin ALL=(ALL) NOPASSWD: ALL' >> /etc/sudoers\n",

              "sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/g' /etc/ssh/sshd_config\n",
              "systemctl restart sshd\n",
            
              "su --login ceph -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/ceph/.ssh/id_rsa\"\n",
              "su --login ceph -c \"cat /home/ceph/.ssh/id_rsa.pub >> /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"ssh-keygen -q -t rsa -P '' -N '' -f /home/admin/.ssh/id_rsa\"\n",
              "su --login admin -c \"cat /home/admin/.ssh/id_rsa.pub >> /home/admin/.ssh/authorized_keys\"\n",

              "cat /home/ec2-user/.ssh/authorized_keys >> /home/ceph/.ssh/authorized_keys\n",
              "cat /home/ec2-user/.ssh/authorized_keys >> /home/admin/.ssh/authorized_keys\n",

              "chown -R ceph /home/ceph\n",
              "chown -R admin /home/admin\n",

              "su --login ceph -c \"chmod 700 /home/ceph/.ssh\"\n",
              "su --login ceph -c \"chmod 600 /home/ceph/.ssh/authorized_keys\"\n",

              "su --login admin -c \"chmod 700 /home/admin/.ssh\"\n",
              "su --login admin -c \"chmod 600 /home/admin/.ssh/authorized_keys\"\n",
              
              "wget https://s3.amazonaws.com/karansingh/test-drive/rhceph-2.2-rhel-7-x86_64.iso -O /home/ceph/rhceph-2.2-rhel-7-x86_64.iso\n",
              "wget https://s3.amazonaws.com/karansingh/test-drive/rhscon-2.0-rhel-7-x86_64.iso -O /home/ceph/rhscon-2.0-rhel-7-x86_64.iso \n",

              "wget https://gist.githubusercontent.com/ksingh7/34f31512edefdecd8136092fb402ac40/raw/2407deeffa3510f0123a3a36676fa46347c003e8/id.pub -O /home/ceph/.ssh/karans_key.pub\n",

              "wget https://gist.githubusercontent.com/ksingh7/34f31512edefdecd8136092fb402ac40/raw/2407deeffa3510f0123a3a36676fa46347c003e8/id.pub -O /home/admin/.ssh/karans_key.pub\n",
              
              "cat /home/ceph/.ssh/karans_key.pub >> /home/ceph/.ssh/authorized_keys\n",
              "cat /home/admin/.ssh/karans_key.pub >> /home/admin/.ssh/authorized_keys\n",

              "mkdir -p /mnt/rhcs2\n",
              "mount /home/ceph/rhceph-2.2-rhel-7-x86_64.iso /mnt/rhcs2\n",
              "mkdir -p /mnt/rhscon2\n",
              "mount /home/ceph/rhscon-2.0-rhel-7-x86_64.iso /mnt/rhscon2\n",
              
              "cat << EOF >/etc/yum.repos.d/RHCS2-repo-server.repo\n",
              "[RHCS2-mon]\n",
              "name=Red Hat Ceph Storage 2 Mon - $basearch\n",
              "baseurl=file:///mnt/rhcs2/MON\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
          
              "[RHCS2-osd]\n",
              "name=Red Hat Ceph Storage 2 osd - $basearch\n",
              "baseurl=file:///mnt/rhcs2/OSD\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHCS2-tools]\n",
              "name=Red Hat Ceph Storage 2 Tools - $basearch\n",
              "baseurl=file:///mnt/rhcs2/Tools\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-repo-agent]\n",
              "name=Red Hat Storage Console 2 Agent - $basearch\n",
              "baseurl=file:///mnt/rhscon2/Agent\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-repo-Installer]\n",
              "name=Red Hat Storage Console 2 Installer - $basearch\n",
              "baseurl=file:///mnt/rhscon2/Installer\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",

              "[RHSCON2-repo-main]\n",
              "name=Red Hat Storage Console 2 Main - $basearch\n",
              "baseurl=file:///mnt/rhscon2/Main\n",
              "enabled=1\n",
              "gpgcheck=1\n",
              "gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-redhat-release\n",
              "EOF\n",
                
              "sed -i 's/Listen 80/Listen 8123/g' /etc/httpd/conf/httpd.conf\n",  
              "cat << EOF >>/etc/httpd/conf/httpd.conf\n",
              "ServerAdmin ceph@mgmt\n",
              "ServerName mgmt\n",
              "EOF\n", 
              
              "mkdir -p /var/www/html/rhcs2 /var/www/html/rhscon2\n",
              "cp -apvR /mnt/rhcs2/* /var/www/html/rhcs2/\n",
              "cp -apvR /mnt/rhscon2/* /var/www/html/rhscon2/\n",

              "systemctl start httpd\n",
              "systemctl enable httpd\n",


              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@osd-node4\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node2\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@mon-node3\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@client-node1\"\n",
              "su --login ceph -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no ceph@rgw-node1\"\n",

              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@osd-node4\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node2\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@mon-node3\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@client-node1\"\n",
              "su --login admin -c \"sshpass -p \"Redhat16\" ssh-copy-id -o StrictHostKeyChecking=no admin@rgw-node1\"\n",
              
              
              "# Now install cfn scripts", "\n",
              "/usr/bin/easy_install --script-dir /opt/aws/bin https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz", "\n",
              "# Now fix the cfn-hup script and copy to init.d location as AWS does not do it for you", "\n",
              "cp -f `pip show aws-cfn-bootstrap 2> /dev/null | egrep  \"^Location\" | awk -F \":\" ' { print $2 }'`/init/redhat/cfn-hup /etc/init.d/", "\n",
              "chmod 755 /etc/init.d/cfn-hup", "\n",
              "chkconfig --add cfn-hup", "\n",

              "/opt/aws/bin/cfn-init -v ",
              " --stack ", { "Ref" : "AWS::StackName" },
              " --resource mgmt ",
              " --configsets Install ",
              " --region ", { "Ref" : "AWS::Region" }, "\n",

              "# All is well so signal success\n",
              "/opt/aws/bin/cfn-signal -e 0 -r \"mgmt node setup complete\" '", { "Ref": "WaitHandle" }, "'\n"

            ]]
          }
        }
      }
    },

    "WaitHandle": {
      "Type": "AWS::CloudFormation::WaitConditionHandle"
    },

    "WaitCondition": {
      "Type": "AWS::CloudFormation::WaitCondition",
      "DependsOn": "mgmt",
      "Properties": {
        "Handle": { "Ref": "WaitHandle" },
        "Timeout": "3000"
      }
    },

    "ManagementNodeIPAddress" : {
      "Type" : "AWS::EC2::EIP",
      "DependsOn" : ["mgmt","InternetGateway"],
      "Properties" : {
        "Domain" : "vpc",
        "InstanceId" : { "Ref" : "mgmt" }
      }
    },

    "RGWNodeIPAddress" : {
      "Type" : "AWS::EC2::EIP",
      "DependsOn" : ["mgmt","InternetGateway"],
      "Properties" : {
        "Domain" : "vpc",
        "InstanceId" : { "Ref" : "rgwnode1" }
      }
    },

    "NATSG" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "DependsOn" : "VPC",
      "Properties" : {
        "GroupDescription" : "Enable internal access to the NAT device",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [
          { "IpProtocol" : "-1", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" },
          { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0" }
          ],
        "SecurityGroupEgress" : [
          { "IpProtocol" : "-1", "FromPort" : "0",  "ToPort" : "65535",  "CidrIp" : "0.0.0.0/0" }]
      }
    },

    "RedHatServerSG" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "DependsOn" : "VPC",
      "Properties" : {
        "GroupDescription" : "Enable access to the RedHatStorage Server devices",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [
           { "IpProtocol" : "-1", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0" },
           { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0" },
           { "IpProtocol" : "tcp", "FromPort" : "8123", "ToPort" : "8123", "CidrIp" : "0.0.0.0/0" }
           ],
        "SecurityGroupEgress" : [
           { "IpProtocol" : "-1", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0" }]
      }
    },

    "RedHatClientSG" : {
      "Type" : "AWS::EC2::SecurityGroup",
      "DependsOn" : "VPC",
      "Properties" : {
        "GroupDescription" : "Enable access to the RedHatStorage Client devices",
        "VpcId" : { "Ref" : "VPC" },
        "SecurityGroupIngress" : [
           { "IpProtocol" : "-1", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0" },
           { "IpProtocol" : "tcp", "FromPort" : "22", "ToPort" : "22", "CidrIp" : "0.0.0.0/0" }],
         "SecurityGroupEgress" : [
           { "IpProtocol" : "-1", "FromPort" : "0", "ToPort" : "65535", "CidrIp" : "0.0.0.0/0" }]
      }
    }
},


  "Outputs" : {
   "ManagementNodePublicIP" : {
      "Description" : "Ceph Management Node Public IP Address",
      "Value" :  { "Ref" : "ManagementNodeIPAddress" }
   },

   "RGWNodePublicIP" : {
      "Description" : "Ceph Object Storage Public IP Address",
      "Value" :  { "Ref" : "RGWNodeIPAddress" }
   },   

   "UserName" : {
      "Description" : "Ceph Management Node User Name",
      "Value" :  "ceph"
   },
   
   "Password" : {
      "Description" : "Ceph Management Node Password",
      "Value" :  "Redhat16"
   }

  }
}
